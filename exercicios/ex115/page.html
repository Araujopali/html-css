<?php
/**
 * Plugin Name: CPT Fênix Grego (Landing Page)
 * Description: Cria um CPT "Fênix Grego" (tipo página) com template de landing integrado e campos para CTA e preços.
 * Version: 1.0.0
 * Author: voce
 */

if (!defined('ABSPATH')) exit;

class FG_Landing_CPT {
    private $meta_keys = [
        'fg_hero_sub', 'fg_cta_label', 'fg_cta_url',
        'fg_p1_title','fg_p1_price','fg_p1_cash',
        'fg_p2_title','fg_p2_price','fg_p2_cash',
        'fg_p3_title','fg_p3_price','fg_p3_cash',
        'fg_p4_title','fg_p4_price','fg_p4_cash',
        'fg_footer_phone','fg_footer_email','fg_footer_cnpj'
    ];

    public function __construct() {
        add_action('init', [$this,'register_cpt']);
        add_action('add_meta_boxes', [$this,'metabox']);
        add_action('save_post_fenix_grego', [$this,'save_meta']);
        add_action('wp_enqueue_scripts', [$this,'enqueue']);
        add_filter('the_content', [$this,'render_landing'], 9999);
    }

    public function register_cpt() {
        $labels = [
            'name'               => 'Fênix Grego',
            'singular_name'      => 'Fênix Grego',
            'menu_name'          => 'Fênix Grego',
            'add_new'            => 'Adicionar novo',
            'add_new_item'       => 'Adicionar Fênix Grego',
            'edit_item'          => 'Editar Fênix Grego',
            'new_item'           => 'Novo Fênix Grego',
            'view_item'          => 'Ver Fênix Grego',
            'search_items'       => 'Buscar',
            'not_found'          => 'Nada encontrado',
            'not_found_in_trash' => 'Nada na lixeira',
        ];

        register_post_type('fenix_grego', [
            'labels' => $labels,
            'public' => true,
            'show_ui' => true,
            'show_in_menu' => true,
            'menu_icon' => 'dashicons-admin-site-alt3',
            'has_archive' => false,
            'rewrite' => ['slug' => 'fenix-grego', 'with_front' => false],
            'hierarchical' => true,                 // Comportamento de "page"
            'capability_type' => 'page',
            'supports' => ['title','thumbnail','revisions','excerpt','page-attributes'],
            'show_in_rest' => true                  // Editor de blocos
        ]);
    }

    public function metabox() {
        add_meta_box('fg_cta_box', 'Configurações do CTA', [$this,'metabox_cta'], 'fenix_grego', 'normal', 'high');
        add_meta_box('fg_prices_box', 'Cartões de Preço (4 opções)', [$this,'metabox_prices'], 'fenix_grego', 'normal', 'default');
        add_meta_box('fg_footer_box', 'Rodapé / Contato', [$this,'metabox_footer'], 'fenix_grego', 'side', 'default');
    }

    public function field($id, $label, $value = '', $type = 'text', $placeholder = '') {
        $value = esc_attr($value);
        $placeholder = esc_attr($placeholder);
        echo "<p><label for='{$id}' style='display:block;font-weight:600;margin-bottom:4px'>{$label}</label>";
        if ($type === 'textarea') {
            echo "<textarea id='{$id}' name='{$id}' rows='3' style='width:100%'>$value</textarea>";
        } else {
            echo "<input type='{$type}' id='{$id}' name='{$id}' value='{$value}' placeholder='{$placeholder}' style='width:100%'/>";
        }
        echo "</p>";
    }

    public function metabox_cta($post) {
        wp_nonce_field('fg_save','fg_nonce');
        $hero_sub   = get_post_meta($post->ID,'fg_hero_sub',true);
        $cta_label  = get_post_meta($post->ID,'fg_cta_label',true) ?: 'EU QUERO FÊNIX GREGO';
        $cta_url    = get_post_meta($post->ID,'fg_cta_url',true);

        $this->field('fg_hero_sub', 'Subtítulo do herói', $hero_sub, 'text', 'Ex.: “20 gotas antes da hora H”');
        $this->field('fg_cta_label','Texto do botão CTA', $cta_label, 'text', 'Ex.: EU QUERO FÊNIX GREGO');
        $this->field('fg_cta_url',  'URL do CTA (com UTMs)', $cta_url, 'url', 'https://sualoja.com/checkout?...');
        echo "<p style='color:#555'>Dica: adicione UTMs no fim da URL para identificar campanha/anúncio.</p>";
    }

    public function metabox_prices($post) {
        for($i=1;$i<=4;$i++){
            $t = get_post_meta($post->ID,"fg_p{$i}_title",true);
            $p = get_post_meta($post->ID,"fg_p{$i}_price",true);
            $c = get_post_meta($post->ID,"fg_p{$i}_cash",true);
            echo "<div style='border:1px solid #ddd;padding:10px;margin-bottom:10px;border-radius:6px'>";
            echo "<h4 style='margin:0 0 10px'>Card {$i}</h4>";
            $this->field("fg_p{$i}_title","Título (ex.: Tratamento 6 meses)", $t);
            $this->field("fg_p{$i}_price","Linha principal (ex.: 12x R$51,13)", $p);
            $this->field("fg_p{$i}_cash","À vista (ex.: ou R$497 à vista)", $c);
            echo "</div>";
        }
        echo "<p style='color:#555'>Obs.: O botão de compra usa o <strong>mesmo CTA</strong> definido acima.</p>";
    }

    public function metabox_footer($post) {
        $phone = get_post_meta($post->ID,'fg_footer_phone',true);
        $email = get_post_meta($post->ID,'fg_footer_email',true);
        $cnpj  = get_post_meta($post->ID,'fg_footer_cnpj',true);

        $this->field('fg_footer_phone','Telefone/WhatsApp', $phone);
        $this->field('fg_footer_email','E-mail de contato', $email);
        $this->field('fg_footer_cnpj','CNPJ', $cnpj);
    }

    public function save_meta($post_id) {
        if (!isset($_POST['fg_nonce']) || !wp_verify_nonce($_POST['fg_nonce'],'fg_save')) return;
        if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) return;
        if (!current_user_can('edit_post',$post_id)) return;

        foreach ($this->meta_keys as $key) {
            if (isset($_POST[$key])) {
                $val = ('fg_cta_url' === $key) ? esc_url_raw($_POST[$key]) : sanitize_text_field($_POST[$key]);
                update_post_meta($post_id, $key, $val);
            }
        }
    }

    public function enqueue() {
        if (!is_singular('fenix_grego')) return;

        // CSS principal
        wp_register_style('fg-landing', false);
        wp_enqueue_style('fg-landing');

        $css = <<<CSS
:root { --bg:#140606; --dark:#250b0b; --text:#f1f1f1; --muted:#d9d9d9; --accent:#ff6a00; --accent2:#ffa100; }
body.single-fenix_grego { background: var(--bg); color: var(--text); }
.fg-wrap { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; line-height:1.55; }
.fg-container { max-width: 1180px; margin: 0 auto; padding: 24px; }
.fg-hero { display:grid; grid-template-columns: 1.1fr 0.9fr; gap: 24px; align-items:center; padding: 40px 0; background:
radial-gradient(1200px 600px at 70% 40%, rgba(255,106,0,.25), transparent 60%),
linear-gradient(180deg, #1b0808 0, #120404 100%); border-radius: 16px; }
.fg-hero h1 { font-size: clamp(28px, 4vw, 42px); margin:0 0 12px; }
.fg-hero p.sub { font-size: clamp(16px,2.2vw,20px); color:var(--muted); margin:0 0 22px; }
.fg-cta { display:inline-block; background: linear-gradient(90deg, var(--accent), var(--accent2)); color:#111; font-weight:800; padding:14px 22px; border-radius:10px; text-decoration:none; box-shadow:0 8px 20px rgba(255,140,0,.25); }
.fg-bottle { justify-self:center; background: radial-gradient(400px 200px at 50% 50%, rgba(255,106,0,.15), transparent 70%); padding: 10px; border-radius: 16px; }
.fg-bottle img { width: 360px; max-width: 100%; height:auto; filter: drop-shadow(0 20px 40px rgba(255,130,0,.25)); }

.fg-section { margin: 56px 0; }
.fg-title { text-align:center; font-size: clamp(26px,3vw,34px); margin-bottom:10px; }
.fg-sub { text-align:center; color: var(--muted); margin-bottom: 28px; }

.fg-cards { display:grid; grid-template-columns: repeat(4,1fr); gap: 18px; }
.fg-card { background: var(--dark); padding: 22px; border-radius: 16px; border:1px solid #3a1010; }
.fg-card h3 { margin:0 0 8px; color:#fff; font-size:20px; }
.fg-card p { margin:0; color:#ddd; font-size:15px; }

.fg-two-col { display:grid; grid-template-columns: 1.1fr 0.9fr; gap: 24px; align-items:center; background: #1a0a0a; border-radius:16px; padding: 28px; }
.fg-two-col .imgbox { text-align:center; }
.fg-two-col .imgbox img { width: 420px; max-width: 100%; filter: drop-shadow(0 18px 40px rgba(255,130,0,.2)); }
.fg-badge { background: radial-gradient(260px 260px at 50% 50%, rgba(255,150,0,.15), transparent 70%); padding:20px; border-radius:50%; display:inline-flex; width:200px; height:200px; align-items:center; justify-content:center; border:3px solid #ffb347; color:#ffb347; font-weight:900; }

.fg-grid-4 { display:grid; grid-template-columns: repeat(4,1fr); gap:18px; }
.fg-ingredient { background:#2a0e0e; border:1px solid #3a1010; padding:20px; border-radius:16px; }
.fg-ingredient h4 { margin:0 0 8px; }

.fg-pricing { display:grid; grid-template-columns: repeat(4,1fr); gap:18px; }
.fg-price { background:#2a0e0e; border:1px solid #3a1010; border-radius:20px; padding:24px; text-align:center; }
.fg-price h5 { margin:0 0 4px; font-size:18px; color:#fff; }
.fg-price .p { font-size:26px; font-weight:800; margin:6px 0 2px; color:#fff; }
.fg-price .cash { color:#ddd; margin-bottom:18px; }
.fg-price .btn { display:inline-block; margin-top:auto; background: linear-gradient(90deg, var(--accent), var(--accent2)); color:#111; font-weight:800; padding:12px 18px; border-radius:10px; text-decoration:none; }

.fg-footer { background:#222; color:#d9d9d9; padding:24px; border-radius:16px; font-size:14px; }
.fg-footer strong { color:#fff; }

@media (max-wi
